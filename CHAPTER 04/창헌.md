# 4장. 테스트 구축하기

테스트도 리팩토링과 마찬가지로 작성하면 효율이 높아진다!

## 테스트 코드의 가치

생각보다 프로그래머들은 코드를 작성하는 시간의 비중이 크지 않다. 많은 부분 디버깅하는데 사용한다. 버그 수정 자체는 오래 걸리지 않지만 이 버그를 찾기 위해 오랜시간이 걸린다.

### 계기

누군가 클래스마다 테스트 코드를 갖춰야 한다는 말을 툭 던졌고, 이 때부터 테스트 코드를 코드베이스에 함께 담기로 했다.
테스트 작업은 일일이 테스트 코드가 콘솔에 출력한 결과를 눈으로 확인해야 해서 굉장히 지루하다. 따라서 이를 컴퓨터에 맡기기로 한다.

컴파일 할 때마다 테스트도 함께 했고, 생산성이 급상승했다. 직전까지 테스트가 성공했고, 현재 버그가 발생했다면 마지막 테스트 이후에 작성한 코드에서 버그가 발생했다는 것을 알기 때문에 의심되는 코드 양이 많지않고, 방금 작성했으니 고치기 수월하다.
=> 함수 몇 개만 작성해도 곧바로 테스트를 추가한다.

테스트 스위트는 강력한 버그 검출 도구로 버그를 찾는데 걸리는 시간을 대폭 줄여준다.

> 테스트 스위트란?  
> 테스트 케이스들을 하나로 묶은 것. 이를 통해 특정한 클래스나 특정한 메소드들을 선택하여 단위 테스트를 할 수 있다.

프로그래밍 시작전에 테스트를 작성하는 것이 가장 좋다.
테스트를 작성하다 보면 어떤 기능을 추가할 지 고민하게 되고, 구현보단 인터페이스에 집중하고, 코딩이 완료되는 시점을 정확하게 판단할 수 있다.

=> 켄트 벡은 테스트부터 작성하는 습관을 바탕으로 테스트 주도 개발(TDD)기법을 창시했다. TDD에서는 처음에는 통과하지 못할 테스트를 작성하고, 이 테스트를 통과하게끔 코드를 작성하고, 결과 코드를 최대한 깔끔하게 리팩터링하는 과정을 짧은 주기로 반복한다.

리팩터링에는 테스트가 필요하다.

## 모카

모카 프레임워크는 테스트 코드를 블록단위로 나눠서 각 블록에 테스트 스위트를 담는 구조이다. 테스트는 `it` 블록에 담긴다.

- 실패해야 할 상황에서는 반드시 실패하게 만들자.
  테스트를 작성하고, 모두 통과했다는 것은 좋은 일이지만 실패한게 없다면 테스트가 내 의도대로 작동하는지 의구심이 든다. 이럴 때 코드에 오류를 주입시켜본다.

- 자주 테스트하고, 작성 중인 코드는 최소한 몇 분 간격으로 테스트하고, 적어도 하루에 한번은 전체 테스트를 돌려보자.

- 어서션 라이브러리라고 하는 픽스처 검증 라이브러리를 선택해 사용할 수 있다. `assert`문을 이용해 코드를 검증할 수 있다.

- 실패한 테스트가 하나라도 있으면 리팩토링하면 안된다.

- 최근 변경을 취소하고, 마지막으로 모든 테스트를 통과했던 상태로 돌아가라

## 테스트 추가하기

- 테스트는 위험 요인을 중심으로 작성해야 한다.
- 테스트의 목적은 어디까지나 현재 혹은 향후에 발생하는 버그를 찾는데 있다. 단순히 필드를 읽고 쓰기만 하는 접근자는 테스트할 필요가 없다.
- 테스트를 너무 많이 만들다 보면 오히려 필요한 테스트를 놓치기 쉽다.
- 완벽하게 해서 테스트를 수행하지 못하느니 불완전한 테스트라도 작성해 실행하는 것이 낫다.
- 테스트끼리 상호작용하게 하는 공유 픽스처를 생성하면 안된다.
  - 테스트를 실행하는 순서에 따라 결과가 달라질 수 있다.
  - 이 공유 객체가 값이 바뀌고, 다른 곳에서 사용하고 있으면 그 곳에서도 버그가 발생 할 수도 있다.

## 픽스처 수정하기

> 픽스처란?  
> 테스트를 실행하기 위해 필요한 모든 것

픽스처의 내용이 수정되는 경우도 흔한데, 이러한 수정은 대부분 세터에서 이뤄진다.  
세터는 보통 단순해서 버그가 잘 발생하지 않지만 복잡한 동작을 수행하면 테스트 해볼 필요가 있다.  
일반적으로 it 구문 하나당 검증도 하나씩 하는 것이 좋다.

## 경계 조건 검사하기

- 값이 비어있을 때
- 숫자라면 0일때
- 음수일 때

이런 식으로 테스트를 작성하다 보면 프로그램에서 특이상황을 어떻게 처리하는 것이 좋을지 생각해 볼 수 있다.

내가 스스로 작성한 코드를 적으로 돌리고 의식적으로 프로그램을 망가뜨리는 방법을 모색한다. 이런 과정에서 생산성과 재미를 끌어올려준다.

## 테스트는 어느 수준까지해야 하는가?

아무리 테스트해도 버그 없는 완벽한 프로그램을 만들 수는 없지만 테스트가 프로그래밍 속도를 높여주는 것은 변함이 없다.  
너무 테스트를 많이 작성하면 오히려 의욕이 떨어져 나중에는 하나도 작성하지 않게 될 위험도 있다. 따라서 위험한 부분에 집중하는 것이 좋다.  
테스트가 모든 버그를 걸러주진 못해도, 안심하고 리팩터링할 수 있는 보호막은 되어준다.

## 기타

이 장에서 다룬 테스트는 단위 테스트에 해당한다. 단위 테스트란 작은영역을 대상으로 빠르게 실행되도록 설계된 테스트다.  
자가 테스트의 대부분을 단위테스트가 차지한다.

한번에 완벽한 테스트를 작성할 순 없다. 계속해서 보강하며, 새로운 기능이 나오면 테스트도 추가한다. 또, 기존의 테스트가 충분히 명확한지, 테스트 과정을 더 이해하기 쉽게 리팩터링할 수 있는지 고민해본다.

버그를 발견하는 즉시 발견한 버그를 명확히 잡아내는 테스트부터 작성하는 습관을 들이는 것이 중요하다.
=> 버그 리포트를 받으면 가장 먼저 그 버그를 드러내는 단위 테스트부터 작성한다.

어느 정도하는 것이 적당한가??  
테스트 커버리지를 기준으로 삼는 사람도 있지만 이는 테스트하지 않은 영역을 찾는데 도움이 될 뿐, 테스트 스위트의 품질과는 크게 상관 없다.

충분한지를 평가하는 기준은 주관적이다.  
누군가 결함을 심으면 테스트가 발견할 것이라는 믿음을 기준으로 할 수 있다. 하지만 이런 건 너무 주관적이다. 하지만 자가 테스트 코드의 목적은 이 믿음을 갖게 해주는 것이다.
